{% extends "base.html" %}
{% load static %}
{% block head_title %}
  Join Re-Dcrypt
{% endblock head_title %}
{% block head %}
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,1,0" />
  <style>
  .form-step {
    display: none;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.5s ease-in-out;
  }

  .form-step.active {
    display: block;
    opacity: 1;
    transform: translateY(0);
  }

  .form-field {
    margin-bottom: 1.5rem;
  }

  .form-field input {
    width: 100%;
    padding: 1rem;
    background-color: rgb(23, 23, 23, 0.7);
    box-shadow: inset 0 2px 0px -0.5px rgba(255, 255, 255, 0.1);
    border-radius: 999px;
    color: #08b74f;
    transition: all 0.3s ease;
    backdrop-filter: blur(13.5px);
    -webkit-backdrop-filter: blur(13.5px);
  }

  .form-field input:focus {
    outline: none;
    background: rgba(8, 183, 79, 0.1);
    box-shadow: inset 0 2px 0px -0.5px rgba(255, 255, 255, 0.1);
  }

  .form-field label {
    display: block;
    margin-bottom: 0.5rem;
    color: #08b74f;
    font-weight: 500;
  }

  .errorlist {
    color: #ef4444;
    font-size: 0.875rem;
    margin-top: 0.5rem;
  }

  #id_hcaptcha {
    margin: 1rem auto;
    display: block;
  }

  .step-progress {
    display: flex;
    align-items: center;
    margin-bottom: 2rem;
  }

  .step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(8, 183, 79, 0.1);
    border: 2px solid #08b74f;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #08b74f;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .step-number.active {
    background: #08b74f;
    color: black;
  }

  .step-line {
    flex: 1;
    height: 2px;
    background: rgba(8, 183, 79, 0.2);
    margin: 0 10px;
  }

  .step-line.active {
    background: #08b74f;
  }

  .welcome-card {
    position: relative;
    overflow: hidden;
    height: 100%;
    background: rgba(0, 0, 0, 0.3);
    border-right: 1px solid rgba(8, 183, 79, 0.2);
    min-height: calc(100vh - 150px);
  }

  .welcome-card .content {
    position: relative;
    z-index: 1;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .welcome-card .logos {
    display: flex;
    justify-content: space-between;
    align-items: start;
    padding: 3rem;
  }

  .welcome-text {
    padding: 2rem;
    margin-top: auto;
  }

  .welcome-text h2 {
    font-size: 4rem;
    font-weight: 900;
    line-height: 1.1;
    color: #fff;
    text-align: left;
  }

  @media (max-width: 768px) {
    .welcome-card {
      height: 250px;
      border-right: none;
      border-bottom: 1px solid rgba(8, 183, 79, 0.2);
      margin-bottom: 0;
      min-height: auto;
    }
    
    .welcome-text h2 {
      font-size: 2.5rem;
      text-align: center;
    }
    
    .welcome-text h2 span {
      display: inline;
      margin-right: 0.5rem;
    }

    .form-container {
      min-height: auto;
    }

    .welcome-card .logos {
      padding: 2rem;
    }
  }

  .gradient-text-green {
    background: linear-gradient(135deg, #08b74f 0%, #002a2a 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .form-container {
    display: flex;
    flex-direction: column;
    min-height: 100%;
    position: relative;
    padding-bottom: 5rem;
  }

  .form-content {
    flex: 1;
  }

  .form-buttons {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1.5rem;
  }

  .step-header {
    margin-bottom: 2rem;
    text-align: center;
  }

  .form-fields {
    text-align: left;
  }

  /* Password strength bar styling */
  #passwordStrengthBar {
    width: 100%;
    height: 6px;
    background-color: #ef4444;
    border-radius: 999px;
    transition: background-color 0.3s;
  }

  .required-field label::after {
    content: " *";
    color: #ef4444;
  }

  .strength-meter {
    width: 90%;
    margin-top: 0.5rem;
    margin-left: auto;
    margin-right: auto;
    transition: opacity 0.3s;
    animation: strengthMeterAppear 0.3s ease-out forwards;
  }

  @keyframes strengthMeterAppear {
    0% {
      transform: translateY(-10px);
      opacity: 0;
    }
    100% {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .strength-label {
    margin-bottom: 0.25rem;
    color: #08b74f;
    font-size: 0.875rem;
    transition: color 0.3s;
  }

  .strength-bars {
    display: flex;
    justify-content: space-between;
    gap: 3px;
  }

  .strength-bar {
    flex: 1;
    height: 6px;
    background-color: #ef4444; /* initial red color */
    transition: width 0.3s, background-color 0.3s;
    border-radius: 999px;
  }

  .hidden {
    display: none;
  }

  .visible {
    display: block;
    opacity: 1;
  }

  .material-symbols-outlined#togglePassword1,
  .material-symbols-outlined#togglePassword2 {
    color: #aaa;
  }
  </style>
{% endblock head %}
{% block content %}
  <div class="justify-center px-4 py-8">
    <div class="max-w-7xl mx-auto min-h-[calc(100vh-150px)] flex items-stretch">
      <!-- Combined Card Container -->
      <div class="bg-neutral-900/70 backdrop-blur-md shadow-inset-white rounded-2xl overflow-hidden flex-1 flex flex-col md:flex-row">
        <div class="flex flex-col md:flex-row w-full">
          <!-- Welcome Card -->
          <div class="md:w-1/2 welcome-card hidden md:block"
               data-aos="fade-right"
               data-aos-duration="800">
            <svg width="100%"
                 height="100%"
                 viewBox="0 0 800 800"
                 style="position: absolute;
                        top: 0;
                        left: 0;
                        z-index: 0">
              <defs>
              <filter id="bb-filter" x="-100%" y="-100%" width="400%" height="400%">
              <feGaussianBlur stdDeviation="105" in="SourceGraphic" result="blur"></feGaussianBlur>
              </filter>
              </defs>
              <g filter="url(#bb-filter)">
              <ellipse rx="277.5" ry="70.5" cx="374" cy="152" fill="#08b74f"></ellipse>
              <ellipse rx="277.5" ry="70.5" cx="609" cy="577" fill="#2e90fa"></ellipse>
              </g>
            </svg>
            <div class="content">
              <div class="logos">
                <img src="{% static 'foss-bu-dark.png' %}"
                     alt="FOSS BU"
                     class="h-8 md:h-12 w-auto"
                     height="auto"
                     width="auto">
                <img src="{% static 'logo.svg' %}"
                     alt="Re-Dcrypt"
                     class="h-8 md:h-12 w-auto"
                     height="auto"
                     width="auto">
              </div>
              <div class="welcome-text">
                <h2>
                  <span class="block text-white/80">Let's</span>
                  <span class="block text-white/80">Get You</span>
                  <span class="block text-white/80">Started</span>
                </h2>
              </div>
            </div>
          </div>
          <!-- Mobile Welcome Card -->
          <div class="md:hidden welcome-card"
               data-aos="fade-down"
               data-aos-duration="800">
            <svg width="100%"
                 height="100%"
                 viewBox="0 0 800 800"
                 style="position: absolute;
                        top: 0;
                        left: 0;
                        z-index: 0">
              <defs>
              <filter id="bb-filter" x="-100%" y="-100%" width="400%" height="400%">
              <feGaussianBlur stdDeviation="105" in="SourceGraphic" result="blur"></feGaussianBlur>
              </filter>
              </defs>
              <g filter="url(#bb-filter)">
              <ellipse rx="277.5" ry="70.5" cx="374" cy="152" fill="#08b74f"></ellipse>
              <ellipse rx="277.5" ry="70.5" cx="609" cy="577" fill="#2e90fa"></ellipse>
              </g>
            </svg>
            <div class="content">
              <div class="logos">
                <img src="{% static 'foss-bu-dark.png' %}"
                     alt="FOSS BU"
                     class="h-8 md:h-12 w-auto"
                     height="auto"
                     width="auto">
                <img src="{% static 'logo.svg' %}"
                     alt="Re-Dcrypt"
                     class="h-8 md:h-12 w-auto"
                     height="auto"
                     width="auto">
              </div>
              <div class="welcome-text">
                <h2>
                  <span class="block text-white/80">Let's</span>
                  <span class="block text-white/80">Get You</span>
                  <span class="block text-white/80">Started</span>
                </h2>
              </div>
            </div>
          </div>
          <!-- Form Section -->
          <div class="md:w-2/3 flex-1" data-aos="fade-up" data-aos-duration="800">
            <form class="signup h-full"
                  id="signup_form"
                  method="post"
                  action="{% url 'account_signup' %}">
              {% csrf_token %}
              <div class="form-container h-full">
                <div class="form-content p-8">
                  <div class="step-progress mb-8"
                       data-aos="fade"
                       data-aos-duration="800"
                       data-aos-delay="200">
                    <div class="step-number active">1</div>
                    <div class="step-line"></div>
                    <div class="step-number">2</div>
                    <div class="step-line"></div>
                    <div class="step-number">3</div>
                  </div>
                  <!-- Step 1: Basic Info -->
                  <div class="form-step active"
                       data-step="1"
                       data-aos="fade-up"
                       data-aos-duration="800"
                       data-aos-delay="300">
                    <div class="step-header flex flex-col items-center mb-6">
                      <span class="flex items-center justify-center w-12 h-12 rounded-full bg-green-600/20 text-green-500 mb-4">
                        <span class="material-symbols-outlined text-3xl">mail</span>
                      </span>
                      <div>
                        <h2 class="text-xl font-bold text-green-500">Let's get started</h2>
                        <p class="text-neutral-400">Enter your basic information to create your account</p>
                      </div>
                    </div>
                    <div class="form-fields">
                      <div class="form-field required-field">
                        <label for="id_email">Email</label>
                        {{ form.email }}
                        <p class="error-message text-red-500 text-sm mt-1 ml-2 hidden"
                           id="email-error"></p>
                      </div>
                      <div class="form-field required-field">
                        <label for="id_username">Username</label>
                        {{ form.username }}
                        <p class="error-message text-red-500 text-sm mt-1 ml-2 hidden"
                           id="username-error"></p>
                      </div>
                    </div>
                  </div>
                  <!-- Step 2: Security -->
                  <div class="form-step"
                       data-step="2"
                       data-aos="fade-up"
                       data-aos-duration="800"
                       data-aos-delay="300">
                    <div class="step-header flex flex-col items-center mb-6">
                      <span class="flex items-center justify-center w-12 h-12 rounded-full bg-purple-600/20 text-purple-500 mb-4">
                        <span class="material-symbols-outlined text-3xl">lock</span>
                      </span>
                      <div>
                        <h2 class="text-xl font-bold text-purple-500">Secure your account</h2>
                        <p class="text-neutral-400">Choose a strong password to protect your account</p>
                      </div>
                    </div>
                    <div class="form-fields">
                      <div class="form-field required-field">
                        <label for="id_password1">Password</label>
                        <div class="relative">
                          {{ form.password1 }}
                          <span class="material-symbols-outlined cursor-pointer text-xl absolute top-3 right-3"
                                id="togglePassword1">visibility</span>
                        </div>
                        <p class="error-message text-red-500 text-sm mt-1 ml-2 hidden"
                           id="password1-error"></p>
                        <!-- Strength meter container -->
                        <div id="passwordStrengthContainer" class="strength-meter hidden">
                          <div class="strength-label" id="strengthLabel">Password Strength</div>
                          <div class="strength-bars">
                            <div class="strength-bar" id="bar1"></div>
                            <div class="strength-bar" id="bar2"></div>
                            <div class="strength-bar" id="bar3"></div>
                          </div>
                        </div>
                      </div>
                      <div class="form-field required-field">
                        <label for="id_password2">Confirm Password</label>
                        <div class="relative">
                          {{ form.password2 }}
                          <span class="material-symbols-outlined cursor-pointer text-xl absolute top-3 right-3"
                                id="togglePassword2">visibility</span>
                        </div>
                        <p class="error-message text-red-500 text-sm mt-1 ml-2 hidden"
                           id="password2-error"></p>
                      </div>
                    </div>
                  </div>
                  <!-- Step 3: Optional Info -->
                  <div class="form-step"
                       data-step="3"
                       data-aos="fade-up"
                       data-aos-duration="800"
                       data-aos-delay="300">
                    <div class="step-header flex flex-col items-center mb-6">
                      <span class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-600/20 text-blue-500 mb-4">
                        <span class="material-symbols-outlined text-3xl">person</span>
                      </span>
                      <div>
                        <h2 class="text-xl font-bold text-blue-500">Almost there!</h2>
                        <p class="text-neutral-400">Add some optional details about yourself</p>
                      </div>
                    </div>
                    <div class="form-fields">
                      <div class="form-field">
                        <label for="id_name">Full Name</label>
                        {{ form.name }}
                      </div>
                      <div class="form-field">
                        <label for="id_organization">School/Organization</label>
                        {{ form.organization }}
                      </div>
                      <div class="form-field">{{ form.hcaptcha }}</div>
                    </div>
                  </div>
                </div>
                <!-- Form Buttons - Step 1 -->
                <div class="form-buttons" data-step="1">
                  <button type="button"
                          class="next-step w-full bg-neutral-900/70 shadow-inset-white hover:bg-green-600 text-neutral-100 hover:text-neutral-50 font-bold py-3 px-6 rounded-full transition-all duration-300">
                    Continue
                  </button>
                </div>
                <!-- Form Buttons - Step 2 -->
                <div class="form-buttons hidden" data-step="2">
                  <div class="flex gap-3">
                    <button type="button"
                            class="prev-step flex-1 bg-neutral-900/70 shadow-inset-white hover:bg-red-600 text-neutral-100 hover:text-neutral-50 font-bold py-3 px-6 rounded-full transition-all duration-300">
                      Back
                    </button>
                    <button type="button"
                            class="next-step flex-1 bg-neutral-900/70 shadow-inset-white hover:bg-green-600 text-neutral-100 hover:text-neutral-50 font-bold py-3 px-6 rounded-full transition-all duration-300">
                      Continue
                    </button>
                  </div>
                </div>
                <!-- Form Buttons - Step 3 -->
                <div class="form-buttons hidden" data-step="3">
                  <div class="flex gap-3">
                    <button type="button"
                            class="prev-step flex-1 bg-neutral-900/70 shadow-inset-white hover:bg-red-600 text-neutral-100 hover:text-neutral-50 font-bold py-3 px-6 rounded-full transition-all duration-300">
                      Back
                    </button>
                    <button type="submit"
                            class="flex-1 bg-neutral-900/70 shadow-inset-white hover:bg-green-600 text-neutral-100 hover:text-neutral-50 font-bold py-3 px-6 rounded-full transition-all duration-300">
                      Complete Signup
                    </button>
                  </div>
                  <p class="text-neutral-400 text-xs mt-4 text-center">
                    By signing up, you agree to Re-Dcrypt's
                    <a href="/terms-and-conditions/" class="text-green-500 hover:underline">Terms of Service</a> and
                    <a href="/privacy-policy/" class="text-green-500 hover:underline">Privacy Policy</a>
                  </p>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('signup_form');
  const steps = form.querySelectorAll('.form-step');
  const stepNumbers = document.querySelectorAll('.step-number');
  const stepLines = document.querySelectorAll('.step-line');
  let currentStep = 1;

  function showStep(stepNumber) {
    steps.forEach(step => {
      step.classList.remove('active');
      if (step.dataset.step == stepNumber) {
        step.classList.add('active');
      }
    });

    // Update step indicators
    stepNumbers.forEach((number, index) => {
      if (index < stepNumber) {
        number.classList.add('active');
      } else {
        number.classList.remove('active');
      }
    });

    // Update connecting lines
    stepLines.forEach((line, index) => {
      if (index < stepNumber - 1) {
        line.classList.add('active');
      } else {
        line.classList.remove('active');
      }
    });

    // Update buttons visibility
    document.querySelectorAll('.form-buttons').forEach(buttons => {
      buttons.classList.add('hidden');
    });
    document.querySelector(`.form-buttons[data-step="${stepNumber}"]`).classList.remove('hidden');
  }

  // Event listeners for navigation
  document.querySelectorAll('.next-step').forEach(button => {
    button.addEventListener('click', async () => {
      if (await validateCurrentStep()) {
        currentStep++;
        showStep(currentStep);
      }
    });
  });

  document.querySelectorAll('.prev-step').forEach(button => {
    button.addEventListener('click', () => {
      currentStep--;
      showStep(currentStep);
    });
  });

  // Validation function
  // async function validateCurrentStep() {
  //   const currentStepEl = document.querySelector(`.form-step[data-step="${currentStep}"]`);
  //   const inputs = currentStepEl.querySelectorAll('input[required]');
  //   let isValid = true;

  //   inputs.forEach(input => {
  //     if (!input.value) {
  //       isValid = false;
  //       input.classList.add('border-red-500');
  //     } else {
  //       input.classList.remove('border-red-500');
  //     }
  //   });

  //   if (currentStep === 1) {
  //     const emailVal = document.getElementById('id_email')?.value.trim();
  //     const usernameVal = document.getElementById('id_username')?.value.trim();
  //     if (emailVal && usernameVal) {
  //       const { emailExists, usernameExists } = await checkEmailUsername(emailVal, usernameVal);
  //       if (emailExists) {
  //         showToast('Email already in use.', 3000);
  //         isValid = false;
  //       }
  //       if (usernameExists) {
  //         showToast('Username already taken.', 3000);
  //         isValid = false;
  //       }
  //     }
  //   }

  //   // Password validation for step 2
  //   if (currentStep === 2) {
  //     const password1 = document.getElementById('id_password1');
  //     const password2 = document.getElementById('id_password2');
      
  //     if (password1.value !== password2.value) {
  //       isValid = false;
  //       password2.classList.add('border-red-500');
  //       showError('Passwords do not match');
  //     }
  //   }

  //   if (currentStep === 3) {
  //     const captchaPassed = await checkCaptcha();
  //     if (!captchaPassed) {
  //       showToast('Captcha verification failed.', 3000);
  //       isValid = false;
  //     }
  //   }

  //   if (!isValid) {
  //     showToast('Please ensure all required fields are properly filled.', 3000);
  //   }
  //   return isValid;
  // }

  // Error display function
  function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'errorlist';
    errorDiv.textContent = message;
    
    // Remove existing error messages
    const existingErrors = document.querySelectorAll('.errorlist');
    existingErrors.forEach(err => err.remove());
    
    const currentStepEl = document.querySelector(`.form-step[data-step="${currentStep}"]`);
    currentStepEl.appendChild(errorDiv);
  }

  // Handle form submission
  form.addEventListener('submit', (e) => {
    if (!validateCurrentStep()) {
      e.preventDefault();
    }
  });

  // Password toggles
  const togglePassword1 = document.getElementById('togglePassword1');
  const password1Input = document.getElementById('id_password1');
  togglePassword1.addEventListener('click', () => {
    if (password1Input.type === 'password') {
      password1Input.type = 'text';
      togglePassword1.textContent = 'visibility_off';
    } else {
      password1Input.type = 'password';
      togglePassword1.textContent = 'visibility';
    }
  });

  const togglePassword2 = document.getElementById('togglePassword2');
  const password2Input = document.getElementById('id_password2');
  togglePassword2.addEventListener('click', () => {
    if (password2Input.type === 'password') {
      password2Input.type = 'text';
      togglePassword2.textContent = 'visibility_off';
    } else {
      password2Input.type = 'password';
      togglePassword2.textContent = 'visibility';
    }
  });

  // Password strength checker
  password1Input.addEventListener('input', updatePasswordStrength);

  function updatePasswordStrength() {
    const val = password1Input.value;
    const container = document.getElementById('passwordStrengthContainer');
    const label = document.getElementById('strengthLabel');
    const bars = [document.getElementById('bar1'), document.getElementById('bar2'), document.getElementById('bar3')];

    // Show/hide meter container
    if (!val.length) {
      container.classList.remove('visible');
      container.classList.add('hidden');
      return;
    } else {
      container.classList.remove('hidden');
      container.classList.add('visible');
    }

    // Strength checks
    let score = 0;
    const lengthCheck = val.length >= 8;
    const hasUppercase = /[A-Z]/.test(val);
    const hasSpecial = /[^a-zA-Z0-9]/.test(val);
    if (lengthCheck) score++;
    if (hasUppercase) score++;
    if (hasSpecial) score++;

    // Reset bars to red
    bars.forEach(bar => bar.style.backgroundColor = '#ef4444');

    // Update bars and label colors
    if (score === 3) {
      bars.forEach(bar => bar.style.backgroundColor = '#22c55e'); // green
      label.textContent = 'Strength: Good';
      label.style.color = '#22c55e';
    } else if (score === 2) {
      bars[0].style.backgroundColor = '#f59e0b'; // yellow
      bars[1].style.backgroundColor = '#f59e0b';
      label.textContent = 'Strength: Medium';
      label.style.color = '#f59e0b';
    } else {
      label.textContent = 'Strength: Bad';
      label.style.color = '#ef4444';
    }
  }

  // Overwrite validateCurrentStep to prevent bad password proceed
  async function validateCurrentStep() {
    const currentStepEl = document.querySelector('.form-step.active');
    const inputs = currentStepEl.querySelectorAll('input[required]');
    let isValid = true;

    // Clear previous errors first
    document.querySelectorAll('.error-message').forEach(el => {
      el.classList.add('hidden');
      el.textContent = '';
    });
    
    inputs.forEach(input => {
      input.classList.remove('border-red-500');
      if (!input.value) {
        isValid = false;
        input.classList.add('border-red-500');
        const errorEl = document.getElementById(`${input.id}-error`);
        if (errorEl) {
          errorEl.textContent = 'This field is required';
          errorEl.classList.remove('hidden');
        }
      }
    });

    if (currentStep === 1) {
      const emailInput = document.getElementById('id_email');
      const usernameInput = document.getElementById('id_username');
      const emailError = document.getElementById('email-error');
      const usernameError = document.getElementById('username-error');
      
      if (emailInput.value && usernameInput.value) {
        const { emailExists, usernameExists } = await checkEmailUsername(
          emailInput.value.trim(),
          usernameInput.value.trim()
        );

        if (emailExists) {
          isValid = false;
          emailInput.classList.add('border-red-500');
          emailError.textContent = 'This email is already in use';
          emailError.classList.remove('hidden');
        }

        if (usernameExists) {
          isValid = false;
          usernameInput.classList.add('border-red-500');
          usernameError.textContent = 'This username is already taken';
          usernameError.classList.remove('hidden');
        }
      }
    }

    // Password validation
    if (currentStep === 2) {
      const password1 = document.getElementById('id_password1');
      const password2 = document.getElementById('id_password2');
      const password1Error = document.getElementById('password1-error');
      const password2Error = document.getElementById('password2-error');
      let isValid = true;
      
      // Reset previous error states
      [password1, password2].forEach(input => {
        input.classList.remove('border-red-500');
      });
      [password1Error, password2Error].forEach(error => {
        error.classList.add('hidden');
        error.textContent = '';
      });

      // Password requirements check
      const requirements = {
        length: password1.value.length >= 8,
        uppercase: /[A-Z]/.test(password1.value),
        special: /[^a-zA-Z0-9]/.test(password1.value),
        numbers: /[0-9]/.test(password1.value)
      };

      const errorMessages = [];
      if (!requirements.length) errorMessages.push('at least 8 characters');
      if (!requirements.uppercase) errorMessages.push('one uppercase letter');
      if (!requirements.special) errorMessages.push('one special character');
      if (!requirements.numbers) errorMessages.push('one number');

      if (errorMessages.length > 0) {
        isValid = false;
        password1.classList.add('border-red-500');
        password1Error.textContent = `Password must contain ${errorMessages.join(', ')}`;
        password1Error.classList.remove('hidden');
        
        // Add animation to error message
        password1Error.style.animation = 'none';
        password1Error.offsetHeight; // Trigger reflow
        password1Error.style.animation = 'fadeInDown 0.3s ease-out';
      }

      // Password match check
      if (password1.value !== password2.value) {
        isValid = false;
        password2.classList.add('border-red-500');
        password2Error.textContent = 'Passwords do not match';
        password2Error.classList.remove('hidden');
        
        // Add animation to error message
        password2Error.style.animation = 'none';
        password2Error.offsetHeight; // Trigger reflow
        password2Error.style.animation = 'fadeInDown 0.3s ease-out';
      }

      return isValid;
    }

    if (currentStep === 3) {
      const captchaPassed = await checkCaptcha();
      console.log(captchaPassed);
      isValid = false;
      if (!captchaPassed) {
        showToast('Captcha verification failed.', 3000, "ERROR");
        isValid = false;
      }
    }

    if (!isValid) {
      showToast('Please ensure all required fields are properly filled.', 3000, "WARNING");
    }
    return isValid;
  }

  async function checkEmailUsername(email, username) {
    // Example AJAX request for checking email + username
    // Adjust the URL or data format as needed
    try {
      const response = await fetch('/account/check-unique/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify({ email, username })
      });
      const data = await response.json();
      return data; // Expecting { emailExists: bool, usernameExists: bool }
    } catch (err) {
      showToast('Error checking username/email', 2000, "ERROR");
      return { emailExists: false, usernameExists: false };
    }
  }

  async function checkCaptcha() {
    const hcaptchaResponse = hcaptcha.getResponse();
    if (!hcaptchaResponse) {
      return false;
    }
    try {
      const response = await fetch('/account/verify-captcha/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify({ 'h-captcha-response': hcaptchaResponse })
      });
      const data = await response.json();
      return data.captchaValid;
    } catch (err) {
      return false;
    }
  }

  // Add animation keyframes
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .error-message {
      opacity: 0;
      transform: translateY(-10px);
    }

    .error-message:not(.hidden) {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }
  `;
  document.head.appendChild(style);
});
  </script>
  {% if form.errors %}
    <script>console.log("{{ form.errors }}");</script>
    {% for field in form %}
      {% for error in field.errors %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {

            console.log("{{ error|escapejs }}");
            showToast("{{ error|escapejs }}", 3000, "ERROR");
            });
        </script>
      {% endfor %}
    {% endfor %}
  {% endif %}
{% endblock content %}
